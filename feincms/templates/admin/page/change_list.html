{% extends "admin/change_list.html" %}
{% load adminmedia admin_list i18n %}

{% block extrahead %}
{{ block.super }}

{% if FEINCMS_ADMIN_MEDIA_HOTLINKING %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
{% else %}
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}jquery-1.3.2.min.js"></script>
{% endif %}
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}toolbox.js"></script>
<script type="text/javascript" src="{{ FEINCMS_ADMIN_MEDIA }}page_toolbox.js"></script>

<style type="text/css">
    table { display: none; }    /* hide table until set up */
</style>

<script type="text/javascript">
    /* This represents the current state of the page tree. Would need to be
       refreshed if pages are moved or deleted, but for now that is not possible */
    var tree_structure = {{ cl.model.page_tree_json }};
    
    /* After loading the page, show all root nodes */
    $(function()
        {
        for(k in tree_structure)
            {
            p = page(k);
            /* Precompute object links for no object-id lookups later */
            m = $('#page_marker-' + k);
            if(m.length)
                {
                p.ptr = m;
                p.row = m.parents('tr:first');
                }
            else /* row not present in changelist, throw node away */
                {
                tree_structure[k] = { }
                }
            }

        /* Clean out tree_structure: Remove non existant parents, children, descendants */
        for(k in tree_structure)
            {
            p = page(k);
            if(p.parent && !page(p.parent).ptr)
                p.parent = null

            if(p.descendants)
                p.descendants = $.grep(p.descendants, function(o) { return page(o).ptr; });

            if(p.children)
                {
                p.children = $.grep(p.children, function(o) { return page(o).ptr; });
                if(p.children.length)
                    p.ptr.text(expand_sym);
                }
            }

        for(k in tree_structure)
            {
            p = page(k);
            if(p.ptr)
                {
                /* Show all root (ie. has no parent) nodes */
                if(p.parent)
                    p.row.hide();
                else
                    p.row.show();
                }
            }

        /* yuck :-) */
        $('table thead tr th:eq(1)').attr('style', 'width: 450px;');

        $('tbody tr').removeClass('row1').removeClass('row2');
        $('table').show();
        recolor_lines();
        });

</script>

{% endblock %}


{% comment %}
      {% block filters %}
        {% if cl.has_filters %}
          <div id="changelist-filter">
            <h2>{% trans 'Filter' %}</h2>
            {% for spec in cl.filter_specs %}{% admin_list_filter cl spec %}{% endfor %}

	<h3>Links</h3>
	<li class="selected"><a href="#">Dings</a> </li>
          </div>
        {% endif %}

      {% endblock %}
{% endcomment %}